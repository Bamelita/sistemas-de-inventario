<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Inventario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .sidebar { transition: all 0.3s ease; }
        .main-content { transition: all 0.3s ease; }
        .low-stock { background-color: #fff3cd; border-left: 4px solid #f39c12; }
        .critical-stock { background-color: #f8d7da; border-left: 4px solid #e74c3c; }
        .movement-entry { background-color: #e8f5e9; }
        .movement-exit { background-color: #ffebee; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed; z-index: 40; height: 100vh; }
            .sidebar.open { transform: translateX(0); }
            .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 30; }
            .overlay.open { display: block; }
        }
        /* Fijar la barra de navegación */
        header {
            position: sticky;
            top: 0;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <button id="menu-toggle" class="lg:hidden text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Gestión de Inventario</h1>
                        <p class="text-sm text-gray-600">Sistema de Gestión Integral</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right hidden md:block">
                        <p class="text-sm text-gray-600">Total Productos</p>
                        <p class="text-xl font-bold text-blue-600" id="totalProducts">0</p>
                    </div>
                    <div class="text-right hidden md:block">
                        <p class="text-sm text-gray-600">Valor Total</p>
                        <p class="text-xl font-bold text-green-600" id="totalValue">$0</p>
                    </div>
                    <div class="text-right hidden lg:block">
                        <p class="text-sm text-gray-600">Tasa BCV</p>
                        <p class="text-lg font-bold text-blue-600">$1 = Bs <span id="exchangeRate">36.50</span></p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Sidebar Navigation -->
        <div class="overlay" id="overlay"></div>
        <div class="sidebar bg-white w-64 min-h-screen shadow-lg fixed lg:relative lg:translate-x-0 z-30" id="sidebar">
            <div class="p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-6">Navegación</h2>
                <nav class="space-y-2">
                    <a href="#" data-tab="dashboard" class="flex items-center space-x-3 p-3 rounded-lg bg-blue-500 text-white transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span>Control Central</span>
                    </a>
                    <a href="#" data-tab="inventory" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <span>Inventario</span>
                    </a>
                    <a href="#" data-tab="movements" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                        <span>Movimientos</span>
                    </a>
                    <a href="#" data-tab="reports" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>Reportes</span>
                    </a>
                    <a href="#" data-tab="categories" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                        <span>Categorías</span>
                    </a>
                    <a href="#" data-tab="settings" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span>Configuración</span>
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content flex-1 lg:ml-6">
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <!-- Summary Cards -->
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Total Productos</p>
                                <p class="text-3xl font-bold" id="dashboardTotalProducts">0</p>
                            </div>
                            <div class="bg-blue-400 p-3 rounded-lg">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100">Valor Inventario</p>
                                <p class="text-3xl font-bold" id="dashboardTotalValue">$0</p>
                                <p class="text-sm" id="dashboardTotalValueBs">Bs 0.00</p>
                            </div>
                            <div class="bg-green-400 p-3 rounded-lg">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-red-100">Stock Bajo</p>
                                <p class="text-3xl font-bold" id="dashboardLowStock">0</p>
                            </div>
                            <div class="bg-red-400 p-3 rounded-lg">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100">Movimientos Hoy</p>
                                <p class="text-3xl font-bold" id="dashboardMovementsToday">0</p>
                            </div>
                            <div class="bg-purple-400 p-3 rounded-lg">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Low Stock Alert -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">⚠️ Productos con Stock Bajo</h3>
                    <div id="lowStockList" class="space-y-3">
                        <!-- Low stock items will be inserted here -->
                    </div>
                </div>

                <!-- Recent Movements -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Movimientos Recientes</h3>
                    <div id="recentMovements" class="space-y-3 max-h-80 overflow-y-auto">
                        <!-- Recent movements will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory-tab" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                        <h2 class="text-xl font-semibold text-gray-900">Lista de Productos</h2>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
                            <input type="text" id="searchInput" placeholder="Buscar productos..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Todas las categorías</option>
                            </select>
                            <button onclick="showAddProductModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                                + Nuevo Producto
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2 border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Código</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Producto</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Categoría</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Stock</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Precio USD</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Precio Bs</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Estado</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable">
                                <!-- Products will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Movements Tab -->
            <div id="movements-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Quick Actions -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Movimiento Rápido</h3>
                        <form id="quickMovementForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Producto</label>
                                <select id="movementProduct" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Seleccionar producto</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                    <select id="movementType" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="entrada">Entrada</option>
                                        <option value="salida">Salida</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad</label>
                                    <input type="number" id="movementQuantity" required min="1" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Motivo</label>
                                <input type="text" id="movementReason" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: Venta, Compra, Ajuste">
                            </div>
                            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition-colors duration-200">
                                Registrar Movimiento
                            </button>
                            <button type="button" onclick="showMultiSaleModal()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 rounded-lg transition-colors duration-200 mt-2">
                                Venta múltiple
                            </button>
                        </form>
                    </div>

                    <!-- Recent Movements -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Movimientos Recientes</h3>
                            <input type="date" id="movementDateFilter" class="px-3 py-1 border border-gray-300 rounded-lg">
                        </div>
                        <div id="movementsList" class="space-y-3 max-h-80 overflow-y-auto">
                            <!-- Movements will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Reportes de Inventario</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha Inicio</label>
                            <input type="date" id="reportStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha Fin</label>
                            <input type="date" id="reportEndDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button onclick="generateReport('stock')" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                            Reporte de Stock
                        </button>
                        <button onclick="generateReport('movements')" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                            Reporte de Movimientos
                        </button>
                        <button onclick="generateReport('valuation')" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                            Valorización
                        </button>
                    </div>
                    
                    <div id="reportResults" class="mt-6">
                        <!-- Report results will be displayed here -->
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Distribución por Productos</h3>
                            <canvas id="productChart" width="400" height="300"></canvas>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Movimientos Mensuales</h3>
                            <canvas id="movementChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Tab -->
            <div id="categories-tab" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                        <h2 class="text-xl font-semibold text-gray-900">Gestión de Categorías</h2>
                        <button onclick="showAddCategoryModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                            + Nueva Categoría
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Total Categorías</h3>
                            <p class="text-3xl font-bold text-blue-600" id="totalCategories">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Categoría con más productos</h3>
                            <p class="text-xl font-bold text-green-600" id="topCategory">-</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Productos sin categoría</h3>
                            <p class="text-3xl font-bold text-red-600" id="uncategorizedProducts">0</p>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2 border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Nombre</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Cantidad de Productos</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Valor Total</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTable">
                                <!-- Categories will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Configuración del Sistema</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Configuración de Tasa de Cambio -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Tasa de Cambio USD/BS</h3>
                            <div class="flex items-center mb-4">
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600 mb-1">Tasa actual:</p>
                                    <p class="text-2xl font-bold text-blue-600">$1 = Bs <span id="currentRateDisplay">36.50</span></p>
                                </div>
                                <button onclick="showExchangeRateModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                                    Cambiar
                                </button>
                            </div>
                            <p class="text-sm text-gray-500">Esta tasa se utiliza para calcular los precios en bolívares de todos los productos.</p>
                        </div>
                        
                        <!-- Configuración de Stock Mínimo -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Alertas de Stock</h3>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Stock mínimo global</label>
                                <input type="number" id="globalMinStock" min="1" value="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <button onclick="updateGlobalMinStock()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                                Actualizar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Configuración de Backup -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Respaldo de Datos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="exportData()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Exportar Datos
                            </button>
                            <label class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center cursor-pointer">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 极 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                Importar Datos
                                <input type="file" id="importFile" class="hidden" accept=".xlsx,.xls" onchange="importData(this.files)">
                            </label>
                        </div>
                        <p class="text-sm text-gray-500 mt-4">Realiza respaldos periódicos de tu información para prevenir pérdidas de datos.</p>
                    </div>

                    <!-- Eliminar todos los datos -->
                    <div class="bg-red-50 p-6 rounded-lg mt-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Eliminar Todos los Datos</h3>
                        <p class="text-sm text-gray-600 mb-4">Esta acción eliminará todos los productos, movimientos y categorías. Esta acción no se puede deshacer.</p>
                        <button onclick="confirmDataDeletion()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                            Eliminar Todos los Datos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Agregar Nuevo Producto</h3>
            <form id="addProductForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Código del Producto</label>
                        <input type="text" id="productCode" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: PROD001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Producto</label>
                        <input type="text" id="productName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: Laptop Dell">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categoría</label>
                        <select id="productCategory" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar categoría</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ubicación en Bodega</label>
                        <input type="text" id="productLocation" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: Estante A-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock Inicial</label>
                        <input type="number" id="productStock" required min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock Mínimo</label>
                        <input type="number" id="productMinStock" required min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Precio Unitario ($)</label>
                        <input type="number" id="productPrice" required min="0" step="0.01" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0.00">
                        <p class="text-sm text-gray-500 mt-1" id="productPriceBs">Bs. 0.00</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
                    <textarea id="productDescription" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Descripción del producto..."></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors duration-200">
                        Guardar Producto
                    </button>
                    <button type="button" onclick="closeModal('addProductModal')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 rounded-lg transition-colors duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Editar Producto</h3>
            <form id="editProductForm" class="space-y-4">
                <input type="hidden" id="editProductId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Código del Producto</label>
                        <input type="text" id="editProductCode" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Producto</label>
                        <input type="text" id="editProductName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categoría</label>
                        <select id="editProductCategory" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar categoría</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ubicación en Bodega</label>
                        <input type="text" id="editProductLocation" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock Actual</label>
                        <input type="number" id="editProductStock" required min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock Mínimo</label>
                        <input type="number" id="editProductMinStock" required min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Precio Unitario ($)</label>
                        <input type="number" id="editProductPrice" required min="0" step="0.01" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-1" id="editProductPriceBs">Bs. 0.00</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
                    <textarea id="editProductDescription" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors duration-200">
                        Actualizar Producto
                    </button>
                    <button type="button" onclick="closeModal('editProductModal')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 rounded-lg transition-colors duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Movement Modal -->
    <div id="movementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Movimiento de Stock</h3>
            <form id="movementForm" class="space-y-4">
                <input type="hidden" id="movementProductId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Movimiento</label>
                    <select id="movementTypeModal" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="entrada">Entrada de Stock</option>
                        <option value="salida">Salida de Stock</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad</label>
                    <input type="number" id="movementQuantityModal" required min="1" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Motivo</label>
                    <textarea id="movementReasonModal" rows="2" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Motivo del movimiento..."></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition-colors duration-200">
                        Registrar Movimiento
                    </button>
                    <button type="button" onclick="closeModal('movementModal')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 rounded-lg transition-colors duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal Venta Múltiple -->
    <div id="multiSaleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Venta Múltiple</h3>
            <form id="multiSaleForm" class="space-y-4">
                <div id="multiSaleProducts"></div>
                <button type="button" onclick="addMultiSaleRow()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg mb-2">
                    + Agregar producto
                </button>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 rounded-lg transition-colors duration-200">
                        Registrar Venta
                    </button>
                    <button type="button" onclick="closeModal('multiSaleModal')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 rounded-lg transition-colors duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Agregar Nueva Categoría</h3>
            <form id="addCategoryForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Categoría</label>
                    <input type="text" id="categoryName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: Electrónicos">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción (Opcional)</label>
                    <textarea id="categoryDescription" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Descripción de la categoría..."></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors duration-200">
                        Guardar Categoría
                    </button>
                    <button type="button" onclick="closeModal('addCategoryModal')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 rounded-lg transition-colors duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Exchange Rate Modal -->
    <div id="exchangeRateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Cambiar Tasa de Cambio</h3>
            <form id="exchangeRateForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tasa Actual (Bs por $1)</label>
                    <p class="text-xl font-bold text-blue-600 mb-2">Bs <span id="currentRate">36.50</span></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nueva Tasa</label>
                    <input type="number" id="newExchangeRate" required min="0" step="0.01" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: 36.50">
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors duration-200">
                        Actualizar Tasa
                    </button>
                    <button type="button" onclick="closeModal('exchangeRateModal')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 rounded-lg transition-colors duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let products = [];
        let movements = [];
        let categories = [];
        let currentTab = 'dashboard';
        // Tasa actualizada según BCV (Banco Central de Venezuela)
        let USD_TO_BS_RATE = 36.50;

        // Initialize the application
        function initializeApp() {
            loadFromLocalStorage();
            if (products.length === 0) {
                initializeSampleData();
            }
            updateDisplay();
            setupEventListeners();
            showTab('dashboard');
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            const savedProducts = localStorage.getItem('inventory_products');
            const savedMovements = localStorage.getItem('inventory_movements');
            const savedCategories = localStorage.getItem('inventory_categories');
            const savedExchangeRate = localStorage.getItem('inventory_exchange_rate');
            
            if (savedProducts) products = JSON.parse(savedProducts);
            if (savedMovements) movements = JSON.parse(savedMovements);
            if (savedCategories) categories = JSON.parse(savedCategories);
            if (savedExchangeRate) USD_TO_BS_RATE = parseFloat(savedExchangeRate);
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('inventory_products', JSON.stringify(products));
            localStorage.setItem('inventory_movements', JSON.stringify(movements));
            localStorage.setItem('inventory_categories', JSON.stringify(categories));
            localStorage.setItem('inventory_exchange_rate', USD_TO_BS_RATE.toString());
        }

        // Initialize with sample data
        function initializeSampleData() {
            categories = [
                "Alimentos", "Bebidas", "Snacks", "Bisutería", "Herramientas", 
                "Maquillaje", "Colonias", "Pinturas de Uñas", "Accesorios Cabello", "Juguetes"
            ];
            
            products = [
                {
                    id: 1,
                    code: 'ALI001',
                    name: 'Arroz Diana 1kg',
                    category: 'Alimentos',
                    location: 'Estante A-1',
                    stock: 25,
                    price: 2.50,
                    minStock: 10,
                    description: 'Arroz blanco premium'
                },
                {
                    id: 2,
                    code: 'BEB001',
                    name: 'Coca Cola 2L',
                    category: 'Bebidas',
                    location: 'Estante B-2',
                    stock: 18,
                    price: 1.80,
                    minStock: 15,
                    description: 'Refresco de cola'
                },
                {
                    id: 3,
                    code: 'SNK001',
                    name: 'Doritos Nacho',
                    category: 'Snacks',
                    location: 'Estante C-3',
                    stock: 12,
                    price: 1.25,
                    minStock: 8,
                    description: 'Chips de maíz sabor nacho'
                },
                {
                    id: 4,
                    code: 'BIS001',
                    name: 'Collar Dorado',
                    category: 'Bisutería',
                    location: 'Estante D-4',
                    stock: 5,
                    price: 8.50,
                    minStock: 3,
                    description: 'Collar de fantasía dorado'
                },
                {
                    id: 5,
                    code: 'HER001',
                    name: 'Destornillador Phillips',
                    category: 'Herramientas',
                    location: 'Estante E-5',
                    stock: 8,
                    price: 4.75,
                    minStock: 5,
                    description: 'Destornillador punta Phillips'
                }
            ];

            movements = [
                {
                    id: 1,
                    productId: 1,
                    productName: 'Arroz Diana 1kg',
                    type: 'entrada',
                    quantity: 10,
                    reason: 'Compra inicial',
                    date: new Date().toISOString()
                },
                {
                    id: 2,
                    productId: 2,
                    productName: 'Coca Cola 2L',
                    type: 'salida',
                    quantity: 3,
                    reason: 'Venta',
                    date: new Date().toISOString()
                },
                {
                    id: 3,
                    productId: 5,
                    productName: 'Destornillador Phillips',
                    type: 'entrada',
                    quantity: 5,
                    reason: 'Reposición',
                    date: new Date().toISOString()
                }
            ];
            
            saveToLocalStorage();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Menu toggle for mobile
            document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);
            document.getElementById('overlay').addEventListener('click', toggleSidebar);
            
            // Navigation
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    showTab(tab.getAttribute('data-tab'));
                });
            });
            
            // Forms
            document.getElementById('addProductForm').addEventListener('submit', addProduct);
            document.getElementById('editProductForm').addEventListener('submit', updateProduct);
            document.getElementById('quickMovementForm').addEventListener('submit', addMovementFromForm);
            document.getElementById('movementForm').addEventListener('submit', addMovementFromModal);
            document.getElementById('addCategoryForm').addEventListener('submit', addCategory);
            document.getElementById('exchangeRateForm').addEventListener('submit', updateExchangeRate);
            
            // Filters
            document.getElementById('searchInput').addEventListener('input', renderInventoryTable);
            document.getElementById('categoryFilter').addEventListener('change', renderInventoryTable);
            document.getElementById('movementDateFilter').addEventListener('change', filterMovements);
            
            // Currency conversion
            document.getElementById('productPrice').addEventListener('input', updatePriceConversion);
            document.getElementById('editProductPrice').addEventListener('input', updateEditPriceConversion);
        }

        // Toggle sidebar for mobile
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('[data-tab]').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('text-gray-700', 'hover:bg-gray-100');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.getElementById(`${tabName}-tab`).classList.add('fade-in');

            // Activate selected tab button
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('bg-blue-500', 'text-white');
            activeBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');

            currentTab = tabName;

            // Update content based on tab
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'inventory') {
                renderInventoryTable();
                updateCategorySelects();
            } else if (tabName === 'movements') {
                updateMovementProductSelect();
                renderMovementsList();
            } else if (tabName === 'reports') {
                generateProductChart(); // <--- Cambiado aquí
                generateMovementChart();
            } else if (tabName === 'categories') {
                renderCategoriesTable();
                updateCategoryStats();
            } else if (tabName === 'settings') {
                updateSettingsPage();
            }
            
            // Close sidebar on mobile after selection
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }

        // Update all displays
        function updateDisplay() {
            updateHeaderStats();
            updateDashboard();
            renderInventoryTable();
            updateMovementProductSelect();
            renderMovementsList();
            updateCategorySelects();
        }

        // Update header statistics
        function updateHeaderStats() {
            const totalProducts = products.reduce((sum, product) => sum + product.stock, 0);
            const totalValue = products.reduce((sum, product) => sum + (product.stock * product.price), 0);

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalValue').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('exchangeRate').textContent = USD_TO_BS_RATE.toFixed(2);
        }

        // Update dashboard
        function updateDashboard() {
            const totalProducts = products.reduce((sum, product) => sum + product.stock, 0);
            const totalValue = products.reduce((sum, product) => sum + (product.stock * product.price), 0);
            const lowStockProducts = products.filter(product => product.stock <= product.minStock);
            
            // Count movements from today
            const today = new Date().toISOString().split('T')[0];
            const movementsToday = movements.filter(movement => 
                movement.date.split('T')[0] === today
            ).length;

            document.getElementById('dashboardTotalProducts').textContent = totalProducts;
            document.getElementById('dashboardTotalValue').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('dashboardTotalValueBs').textContent = `Bs ${(totalValue * USD_TO_BS_RATE).toFixed(2)}`;
            document.getElementById('dashboardLowStock').textContent = lowStockProducts.length;
            document.getElementById('dashboardMovementsToday').textContent = movementsToday;

            // Render low stock list
            const lowStockContainer = document.getElementById('lowStockList');
            if (lowStockProducts.length > 0) {
                lowStockContainer.innerHTML = lowStockProducts.map(product => `
                    <div class="flex items-center justify-between p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-900">${product.name}</p>
                            <p class="text-sm text-gray-600">Código: ${product.code}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-red-600">Stock: ${product.stock}</p>
                            <p class="text-sm text-gray-600">Mínimo: ${product.minStock}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                lowStockContainer.innerHTML = '<p class="text-green-600 text-center py-8">✅ Todos los productos tienen stock suficiente</p>';
            }

            // Render recent movements
            renderRecentMovements();
        }

        // Update category selects
        function updateCategorySelects() {
            const categorySelects = [
                document.getElementById('categoryFilter'),
                document.getElementById('productCategory'),
                document.getElementById('editProductCategory')
            ];
            
            categorySelects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Seleccionar categoría</option>';
                    categories.forEach(category => {
                        select.innerHTML += `<option value="${category}">${category}</option>`;
                    });
                }
            });
        }

        // Render inventory table
        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTable');
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';

            let filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                    product.code.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            tbody.innerHTML = filteredProducts.map(product => {
                const stockStatus = product.stock === 0 ? 'critical' : (product.stock <= product.minStock ? 'low' : 'normal');
                const statusColor = stockStatus === 'critical' ? 'bg-red-100 text-red-800' : 
                                  (stockStatus === 'low' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800');
                const statusText = stockStatus === 'critical' ? 'Sin Stock' : 
                                 (stockStatus === 'low' ? 'Stock Bajo' : 'Normal');

                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors duration-150 ${stockStatus === 'low' ? 'low-stock' : ''} ${stockStatus === 'critical' ? 'critical-stock' : ''}">
                        <td class="py-4 px-4 font-mono text-sm">${product.code}</td>
                        <td class="py-4 px-4 font-medium">${product.name}</td>
                        <td class="py-4 px-4">
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                                ${product.category}
                            </span>
                        </td>
                        <td class="py-4 px-4 font-semibold ${product.stock <= product.minStock ? 'text-red-600' : 'text-gray-900'}">${product.stock}</td>
                        <td class="py-4 px-4 font-semibold text-green-600">$${product.price.toFixed(2)}</td>
                        <td class="py-4 px-4 font-semibold text-blue-600">Bs ${(product.price * USD_TO_BS_RATE).toFixed(2)}</td>
                        <td class="py-4 px-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="py-4 px-4">
                            <div class="flex space-x-2">
                                <button onclick="editProduct(${product.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200">
                                    Editar
                                </button>
                                <button onclick="showMovementModal(${product.id})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200">
                                    Movimiento
                                </button>
                                <button onclick="deleteProduct(${product.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200">
                                    Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No hay productos en el inventario</td></tr>';
            }
        }

        // Show add product modal
        function showAddProductModal() {
            document.getElementById('addProductForm').reset();
            document.getElementById('productPriceBs').textContent = 'Bs. 0.00';
            showModal('addProductModal');
        }

        // Add new product
        function addProduct(event) {
            event.preventDefault();
            
            const code = document.getElementById('productCode').value;
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const location = document.getElementById('productLocation').value;
            const stock = parseInt(document.getElementById('productStock').value);
            const price = parseFloat(document.getElementById('productPrice').value);
            const minStock = parseInt(document.getElementById('productMinStock').value);
            const description = document.getElementById('productDescription').value;

            // Check if code already exists
            if (products.some(p => p.code === code)) {
                alert('El código del producto ya existe');
                return;
            }

            const newProduct = {
                id: Date.now(),
                code,
                name,
                category,
                location,
                stock,
                price,
                minStock,
                description
            };

            products.push(newProduct);
            
            // Add initial stock movement
            if (stock > 0) {
                movements.push({
                    id: Date.now(),
                    productId: newProduct.id,
                    productName: name,
                    type: 'entrada',
                    quantity: stock,
                    reason: 'Stock inicial',
                    date: new Date().toISOString()
                });
            }

            saveToLocalStorage();
            closeModal('addProductModal');
            updateDisplay();
            showNotification('Producto agregado exitosamente', 'success');
        }

        // Edit product
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductCode').value = product.code;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductCategory').value = product.category;
            document.getElementById('editProductLocation').value = product.location;
            document.getElementById('editProductStock').value = product.stock;
            document.getElementById('editProductMinStock').value = product.minStock;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductDescription').value = product.description;
            
            // Update currency conversion
            document.getElementById('editProductPriceBs').textContent = `Bs. ${(product.price * USD_TO_BS_RATE).toFixed(2)}`;
            
            showModal('editProductModal');
        }

        // Update product
        function updateProduct(event) {
            event.preventDefault();
            
            const id = parseInt(document.getElementById('editProductId').value);
            const code = document.getElementById('editProductCode').value;
            const name = document.getElementById('editProductName').value;
            const category = document.getElementById('editProductCategory').value;
            const location = document.getElementById('editProductLocation').value;
            const stock = parseInt(document.getElementById('editProductStock').value);
            const price = parseFloat(document.getElementById('editProductPrice').value);
            const minStock = parseInt(document.getElementById('editProductMinStock').value);
            const description = document.getElementById('editProductDescription').value;

            const productIndex = products.findIndex(p => p.id === id);
            if (productIndex === -1) return;

            const oldStock = products[productIndex].stock;
            products[productIndex].code = code;
            products[productIndex].name = name;
            products[productIndex].category = category;
            products[productIndex].location = location;
            products[productIndex].stock = stock;
            products[productIndex].price = price;
            products[productIndex].minStock = minStock;
            products[productIndex].description = description;

            // Record stock adjustment if changed
            if (oldStock !== stock) {
                const difference = stock - oldStock;
                movements.push({
                    id: Date.now(),
                    productId: id,
                    productName: name,
                    type: difference > 0 ? 'entrada' : 'salida',
                    quantity: Math.abs(difference),
                    reason: 'Ajuste de inventario',
                    date: new Date().toISOString()
                });
            }

            saveToLocalStorage();
            closeModal('editProductModal');
            updateDisplay();
            showNotification('Producto actualizado exitosamente', 'success');
        }

        // Delete product
        function deleteProduct(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                const product = products.find(p => p.id === id);
                products = products.filter(p => p.id !== id);
                
                // Record deletion movement
                if (product) {
                    movements.push({
                        id: Date.now(),
                        productId: id,
                        productName: product.name,
                        type: 'salida',
                        quantity: product.stock,
                        reason: 'Producto eliminado',
                        date: new Date().toISOString()
                    });
                }
                
                saveToLocalStorage();
                updateDisplay();
                showNotification('Producto eliminado exitosamente', 'success');
            }
        }

        // Update movement product select
        function updateMovementProductSelect() {
            const select = document.getElementById('movementProduct');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar producto</option>' +
                    products.map(product => 
                        `<option value="${product.id}">${product.name} (Stock: ${product.stock})</option>`
                    ).join('');
            }
        }

        // Show movement modal
        function showMovementModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('movementProductId').value = product.id;
            document.getElementById('movementQuantityModal').value = '';
            document.getElementById('movementReasonModal').value = '';
            
            showModal('movementModal');
        }

        // Add movement from modal

        function addMovementFromModal(event) {
            event.preventDefault();
            
            const productId = parseInt(document.getElementById('movementProductId').value);
            const type = document.getElementById('movementTypeModal').value;
            const quantity = parseInt(document.getElementById('movementQuantityModal').value);
            const reason = document.getElementById('movementReasonModal').value;

            processMovement(productId, type, quantity, reason);
            closeModal('movementModal');
        }

        // Add movement from form
        function addMovementFromForm(event) {
            event.preventDefault();
            
            const productId = parseInt(document.getElementById('movementProduct').value);
            const type = document.getElementById('movementType').value;
            const quantity = parseInt(document.getElementById('movementQuantity').value);
            const reason = document.getElementById('movementReason').value;

            processMovement(productId, type, quantity, reason);
            document.getElementById('quickMovementForm').reset();
        }

        // Process movement
        function processMovement(productId, type, quantity, reason) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Validate stock for outgoing movements
            if (type === 'salida' && quantity > product.stock) {
                alert('No hay suficiente stock disponible');
                return;
            }

            // Update product stock
            if (type === 'entrada') {
                product.stock += quantity;
            } else {
                product.stock -= quantity;
            }

            // Add movement record
            movements.push({
                id: Date.now(),
                productId: productId,
                productName: product.name,
                type: type,
                quantity: quantity,
                reason: reason,
                date: new Date().toISOString()
            });

            saveToLocalStorage();
            updateDisplay();
            renderRecentMovements(); // <-- Asegura actualización inmediata
            showNotification('Movimiento registrado exitosamente', 'success');
        }

        // Render movements list
        function renderMovementsList() {
            const container = document.getElementById('movementsList');
            const dateFilter = document.getElementById('movementDateFilter')?.value;
            
            let filteredMovements = movements;
            if (dateFilter) {
                filteredMovements = movements.filter(movement => 
                    movement.date.split('T')[0] === dateFilter
                );
            }
            
            // Sort by date (newest first)
            filteredMovements.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = filteredMovements.map(movement => {
                const typeColor = movement.type === 'entrada' ? 'text-green-600' : 'text-red-600';
                const typeIcon = movement.type === 'entrada' ? '↗️' : '↙️';
                const date = new Date(movement.date).toLocaleString('es-ES');

                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span class="text-lg">${typeIcon}</span>
                            <div>
                                <p class="font-medium text-gray-900">${movement.productName}</p>
                                <p class="text-sm text-gray-600">${movement.reason}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold ${typeColor}">${movement.type === 'entrada' ? '+' : '-'}${movement.quantity}</p>
                            <p class="text-xs text-gray-500">${date}</p>
                        </div>
                    </div>
                `;
            }).join('');

            if (filteredMovements.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay movimientos registrados</p>';
            }
        }

        // Render recent movements for dashboard
        function renderRecentMovements() {
            const container = document.getElementById('recentMovements');
            // Get the 5 most recent movements
            const recentMovements = [...movements].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            container.innerHTML = recentMovements.map(movement => {
                const typeColor = movement.type === 'entrada' ? 'text-green-600' : 'text-red-600';
                const typeIcon = movement.type === 'entrada' ? '↗️' : '↙️';
                const date = new Date(movement.date).toLocaleString('es-ES');

                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span class="text-lg">${typeIcon}</span>
                            <div>
                                <p class="font-medium text-gray-900">${movement.productName}</p>
                                <p class="text-sm text-gray-600">${movement.reason}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold ${typeColor}">${movement.type === 'entrada' ? '+' : '-'}${movement.quantity}</p>
                            <p class="text-xs text-gray-500">${date}</p>
                        </div>
                    </div>
                `;
            }).join('');

            if (recentMovements.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay movimientos recientes</p>';
            }
        }

        // Filter movements by date
        function filterMovements() {
            renderMovementsList();
        }

        // Update price conversion
        function updatePriceConversion() {
            const price = parseFloat(document.getElementById('productPrice').value) || 0;
            document.getElementById('productPriceBs').textContent = `Bs. ${(price * USD_TO_BS_RATE).toFixed(2)}`;
        }

        // Update edit price conversion
        function updateEditPriceConversion() {
            const price = parseFloat(document.getElementById('editProductPrice').value) || 0;
            document.getElementById('editProductPriceBs').textContent = `Bs. ${(price * USD_TO_BS_RATE).toFixed(2)}`;
        }

        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('flex');
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transition-all duration-300 transform translate-x-full`;

            if (type === 'success') {
                notification.classList.add('bg-green-500');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500');
            } else {
                notification.classList.add('bg-blue-500');
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Generate reports
        function generateReport(type) {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const resultsContainer = document.getElementById('reportResults');
            
            let reportHTML = '';
            
            if (type === 'stock') {
                // Stock report
                const lowStockProducts = products.filter(p => p.stock <= p.minStock);
                const criticalStockProducts = products.filter(p => p.stock === 0);
                
                reportHTML = `
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Reporte de Stock</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-sm text-blue-600">Total Productos</p>
                                <p class="text-2xl font-bold">${products.length}</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <p class="text-sm text-yellow-600">Productos con Stock Bajo</p>
                                <p class="text-2xl font-bold">${lowStockProducts.length}</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg">
                                <p class="text-sm text-red-600">Productos Sin Stock</p>
                                <p class="text-2xl font-bold">${criticalStockProducts.length}</p>
                            </div>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">Productos con Stock Bajo</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="text-left py-2 px-4">Producto</th>
                                        <th class="text-left py-2 px-4">Stock Actual</th>
                                        <th class="text-left py-2 px-4">Stock Mínimo</th>
                                        <th class="text-left py-2 px-4">Diferencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${lowStockProducts.map(product => `
                                        <tr class="border-b">
                                            <td class="py-2 px-4">${product.name}</td>
                                            <td class="py-2 px-4">${product.stock}</td>
                                            <td class="py-2 px-4">${product.minStock}</td>
                                            <td class="py-2 px-4 text-red-600">${product.stock - product.minStock}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (type === 'movements') {
                // Movements report
                let filteredMovements = movements;
                if (startDate && endDate) {
                    filteredMovements = movements.filter(m => {
                        const movementDate = m.date.split('T')[0];
                        return movementDate >= startDate && movementDate <= endDate;
                    });
                }
                
                const entradaCount = filteredMovements.filter(m => m.type === 'entrada').length;
                const salidaCount = filteredMovements.filter(m => m.type === 'salida').length;
                const entradaTotal = filteredMovements.filter(m => m.type === 'entrada').reduce((sum, m) => sum + m.quantity, 0);
                const salidaTotal = filteredMovements.filter(m => m.type === 'salida').reduce((sum, m) => sum + m.quantity, 0);
                
                reportHTML = `
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Reporte de Movimientos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-sm text-blue-600">Total Movimientos</p>
                                <p class="text-2xl font-bold">${filteredMovements.length}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <p class="text-sm text-green-600">Entradas</p>
                                <p class="text-2xl font-bold">${entradaCount}</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg">
                                <p class="text-sm text-red-600">Salidas</p>
                                <p class="text-2xl font-bold">${salidaCount}</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="text-sm text-purple-600">Balance Neto</p>
                                <p class="text-2xl font-bold">${entradaTotal - salidaTotal}</p>
                            </div>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">Detalle de Movimientos</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="text-left py-2 px-4">Fecha</th>
                                        <th class="text-left py-2 px-4">Producto</th>
                                        <th class="text-left py-2 px-4">Tipo</th>
                                        <th class="text-left py-2 px-4">Cantidad</th>
                                        <th class="text-left py-2 px-4">Motivo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredMovements.map(movement => `
                                        <tr class="border-b">
                                            <td class="py-2 px-4">${new Date(movement.date).toLocaleDateString('es-ES')}</td>
                                            <td class="py-2 px-4">${movement.productName}</td>
                                            <td class="py-2 px-4"><span class="px-2 py-1 rounded-full text-xs ${movement.type === 'entrada' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${movement.type}</span></td>
                                            <td class="py-2 px-4">${movement.quantity}</td>
                                            <td class="py-2 px-4">${movement.reason}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (type === 'valuation') {
                // Valuation report
                const totalValueUSD = products.reduce((sum, p) => sum + (p.stock * p.price), 0);
                const totalValueBS = totalValueUSD * USD_TO_BS_RATE;
                
                reportHTML = `
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Reporte de Valorización</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-green-50 p-4 rounded-lg">
                                <p class="text-sm text-green-600">Valor Total en USD</p>
                                <p class="text-2xl font-bold">$${totalValueUSD.toFixed(2)}</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-sm text-blue-600">Valor Total en Bs</p>
                                <p class="text-2xl font-bold">Bs ${totalValueBS.toFixed(2)}</p>
                            </div>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">Valorización por Categoría</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="text-left py-2 px-4">Categoría</th>
                                        <th class="text-left py-2 px-4">Cantidad de Productos</th>
                                        <th class="text-left py-2 px-4">Valor en USD</th>
                                        <th class="text-left py-2 px-4">Valor en Bs</th>
                                        <th class="text-left py-2 px-4">% del Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Array.from(new Set(products.map(p => p.category))).map(category => {
                                        const categoryProducts = products.filter(p => p.category === category);
                                        const categoryValueUSD = categoryProducts.reduce((sum, p) => sum + (p.stock * p.price), 0);
                                        const categoryValueBS = categoryValueUSD * USD_TO_BS_RATE;
                                        const percentage = (categoryValueUSD / totalValueUSD) * 100;
                                        
                                        return `
                                            <tr class="border-b">
                                                <td class="py-2 px-4">${category}</td>
                                                <td class="py-2 px-4">${categoryProducts.length}</td>
                                                <td class="py-2 px-4">$${categoryValueUSD.toFixed(2)}</td>
                                                <td class="py-2 px-4">Bs ${categoryValueBS.toFixed(2)}</td>
                                                <td class="py-2 px-4">${percentage.toFixed(2)}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            resultsContainer.innerHTML = reportHTML;
        }

        // Generate product chart
        function generateProductChart() {
            const ctx = document.getElementById('productChart');

            // Destruir gráfico anterior si existe
            if (ctx.chart) {
                ctx.chart.destroy();
            }

            // Mostrar solo los 10 productos con más stock (o todos si hay menos de 10)
            const sortedProducts = [...products].sort((a, b) => b.stock - a.stock).slice(0, 10);
            const labels = sortedProducts.map(p => p.name);
            const data = sortedProducts.map(p => p.stock);

            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB'
            ];

            ctx.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stock',
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Generate movement chart
        function generateMovementChart() {
            const ctx = document.getElementById('movementChart');
            
            // Destroy existing chart if it exists
            if (ctx.chart) {
                ctx.chart.destroy();
            }
            
            // Get last 6 months
            const months = [];
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const today = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                months.push(`${monthNames[date.getMonth()]} ${date.getFullYear()}`);
            }
            
            // Count movements by month
            const entradaData = new Array(6).fill(0);
            const salidaData = new Array(6).fill(0);
            
            movements.forEach(movement => {
                const movementDate = new Date(movement.date);
                const monthDiff = (today.getMonth() - movementDate.getMonth()) + 
                                 (12 * (today.getFullYear() - movementDate.getFullYear()));
                
                if (monthDiff >= 0 && monthDiff < 6) {
                    const index = 5 - monthDiff;
                    if (movement.type === 'entrada') {
                        entradaData[index] += movement.quantity;
                    } else {
                        salidaData[index] += movement.quantity;
                    }
                }
            });
            
            ctx.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Entradas',
                            data: entradaData,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Salidas',
                            data: salidaData,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Show add category modal
        function showAddCategoryModal() {
            document.getElementById('addCategoryForm').reset();
            showModal('addCategoryModal');
        }

        // Add new category
        function addCategory(event) {
            event.preventDefault();
            
            const name = document.getElementById('categoryName').value;
            const description = document.getElementById('categoryDescription').value;

            // Check if category already exists
            if (categories.includes(name)) {
                alert('La categoría ya existe');
                return;
            }

            categories.push(name);
            
            saveToLocalStorage();
            closeModal('addCategoryModal');
            updateCategorySelects();
            renderCategoriesTable();
            updateCategoryStats();
            showNotification('Categoría agregada exitosamente', 'success');
        }

        // Render categories table
        function renderCategoriesTable() {
            const tbody = document.getElementById('categoriesTable');
            
            // Count products by category
            const categoryStats = {};
            categories.forEach(category => {
                categoryStats[category] = {
                    count: 0,
                    value: 0
                };
            });
            
            products.forEach(product => {
                if (categoryStats[product.category]) {
                    categoryStats[product.category].count++;
                    categoryStats[product.category].value += product.stock * product.price;
                }
            });
            
            tbody.innerHTML = categories.map(category => {
                const stats = categoryStats[category] || { count: 0, value: 0 };
                
                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-4 px-4 font-medium">${category}</td>
                        <td class="py-4 px-4">${stats.count} productos</td>
                        <td class="py-4 px-4">
                            <div>$${stats.value.toFixed(2)}</div>
                            <div class="text-sm text-gray-500">Bs ${(stats.value * USD_TO_BS_RATE).toFixed(2)}</div>
                        </td>
                        <td class="py-4 px-4">
                            <button onclick="deleteCategory('${category}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            if (categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">No hay categorías definidas</td></tr>';
            }
        }

        // Update category statistics
        function updateCategoryStats() {
            // Count products by category
            const categoryCounts = {};
            categories.forEach(category => {
                categoryCounts[category] = 0;
            });
            
            products.forEach(product => {
                if (categoryCounts[product.category] !== undefined) {
                    categoryCounts[product.category]++;
                }
            });
            
            // Find category with most products
            let topCategory = '-';
            let maxCount = 0;
            
            for (const [category, count] of Object.entries(categoryCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    topCategory = category;
                }
            }
            
            // Count uncategorized products
            const uncategorizedProducts = products.filter(p => !categories.includes(p.category)).length;
            
            document.getElementById('totalCategories').textContent = categories.length;
            document.getElementById('topCategory').textContent = topCategory;
            document.getElementById('uncategorizedProducts').textContent = uncategorizedProducts;
        }

        // Delete category
        function deleteCategory(categoryName) {
            if (confirm(`¿Estás seguro de que quieres eliminar la categoría "${categoryName}"? Los productos en esta categoría quedarán sin categoría.`)) {
                categories = categories.filter(c => c !== categoryName);
                
                // Update products with this category to uncategorized
                products.forEach(product => {
                    if (product.category === categoryName) {
                        product.category = '';
                    }
                });
                
                saveToLocalStorage();
                updateCategorySelects();
                renderCategoriesTable();
                updateCategoryStats();
                showNotification('Categoría eliminada exitosamente', 'success');
            }
        }

        // Update settings page
        function updateSettingsPage() {
            // Update exchange rate display
            document.getElementById('currentRateDisplay').textContent = USD_TO_BS_RATE.toFixed(2);
        }

        // Show exchange rate modal
        function showExchangeRateModal() {
            document.getElementById('currentRate').textContent = USD_TO_BS_RATE.toFixed(2);
            document.getElementById('newExchangeRate').value = '';
            showModal('exchangeRateModal');
        }

        // Update exchange rate
        function updateExchangeRate(event) {
            event.preventDefault();
            
            const newRate = parseFloat(document.getElementById('newExchangeRate').value);
            
            if (isNaN(newRate) || newRate <= 0) {
                alert('Por favor ingresa una tasa de cambio válida');
                return;
            }
            
            USD_TO_BS_RATE = newRate;
            saveToLocalStorage();
            closeModal('exchangeRateModal');
            updateDisplay();
            updateSettingsPage();
            showNotification('Tasa de cambio actualizada exitosamente', 'success');
        }

        // Update global minimum stock
        function updateGlobalMinStock() {
            const newMinStock = parseInt(document.getElementById('globalMinStock').value);

            if (isNaN(newMinStock) || newMinStock < 0) {
                alert('Por favor ingresa un valor válido para el stock mínimo');
                return;
            }

            // Update all products
            products.forEach(product => {
                product.minStock = newMinStock;
            });

            saveToLocalStorage();
            showNotification('Stock mínimo global actualizado exitosamente', 'success');
            updateDisplay();
        }

        // Export data to Excel
        function exportData() {
            // Prepare data for each sheet
            const productsSheet = products.map(p => ({
                ID: p.id,
                Código: p.code,
                Nombre: p.name,
                Categoría: p.category,
                Ubicación: p.location,
                Stock: p.stock,
                'Stock Mínimo': p.minStock,
                Precio: p.price,
                Descripción: p.description
            }));

            const movementsSheet = movements.map(m => ({
                ID: m.id,
                Producto: m.productName,
                Tipo: m.type,
                Cantidad: m.quantity,
                Motivo: m.reason,
                Fecha: new Date(m.date).toLocaleString('es-ES')
            }));

            const categoriesSheet = categories.map(c => ({ Categoría: c }));

            // Create Excel workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(productsSheet), "Productos");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(movementsSheet), "Movimientos");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(categoriesSheet), "Categorías");

            // Export file
            XLSX.writeFile(wb, `inventario_${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Datos exportados a Excel exitosamente', 'success');
        }

        // Import data from Excel
        function importData(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Parse products sheet
                    if (workbook.Sheets["Productos"]) {
                        const productsData = XLSX.utils.sheet_to_json(workbook.Sheets["Productos"]);
                        products = productsData.map(p => ({
                            id: p.ID || Date.now() + Math.random(),
                            code: p.Código,
                            name: p.Nombre,
                            category: p.Categoría,
                            location: p.Ubicación,
                            stock: p.Stock,
                            price: p.Precio,
                            minStock: p['Stock Mínimo'],
                            description: p.Descripción
                        }));
                    }
                    
                    // Parse movements sheet
                    if (workbook.Sheets["Movimientos"]) {
                        const movementsData = XLSX.utils.sheet_to_json(workbook.Sheets["Movimientos"]);
                        movements = movementsData.map(m => ({
                            id: m.ID || Date.now() + Math.random(),
                            productId: m['ID Producto'] || 0,
                            productName: m.Producto,
                            type: m.Tipo,
                            quantity: m.Cantidad,
                            reason: m.Motivo,
                            date: m.Fecha ? new Date(m.Fecha).toISOString() : new Date().toISOString()
                        }));
                    }
                    
                    // Parse categories sheet
                    if (workbook.Sheets["Categorías"]) {
                        const categoriesData = XLSX.utils.sheet_to_json(workbook.Sheets["Categorías"]);
                        categories = categoriesData.map(c => c.Categoría);
                    }
                    
                    saveToLocalStorage();
                    updateDisplay();
                    showNotification('Datos importados exitosamente desde Excel', 'success');
                } catch (error) {
                    alert('Error al importar los datos: El archivo Excel no es válido');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Confirm data deletion
        function confirmDataDeletion() {
            if (confirm('¿Estás seguro de que quieres eliminar TODOS los datos? Esta acción no se puede deshacer.')) {
                deleteAllData();
            }
        }

        // Delete all data
        function deleteAllData() {
            products = [];
            movements = [];
            categories = [];
            
            saveToLocalStorage();
            updateDisplay();
            showNotification('Todos los datos han sido eliminados', 'success');
        }

        function showMultiSaleModal() {
            document.getElementById('multiSaleForm').reset?.();
            document.getElementById('multiSaleProducts').innerHTML = '';
            addMultiSaleRow();
            showModal('multiSaleModal');
        }

        function addMultiSaleRow() {
            const container = document.getElementById('multiSaleProducts');
            const rowId = Date.now();
            const options = products.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.stock})</option>`).join('');
            const row = document.createElement('div');
            row.className = "flex space-x-2 mb-2";
            row.innerHTML = `
                <select required class="flex-1 px-2 py-2 border border-gray-300 rounded-lg" name="product">
                    <option value="">Producto</option>
                    ${options}
                </select>
                <input type="number" min="1" required class="w-24 px-2 py-2 border border-gray-300 rounded-lg" name="quantity" placeholder="Cantidad">
                <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 hover:bg-red-600 text-white px-2 rounded">✕</button>
            `;
            container.appendChild(row);
        }

        document.getElementById('multiSaleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const rows = Array.from(document.getElementById('multiSaleProducts').children);
            let error = false;
            rows.forEach(row => {
                const productId = parseInt(row.querySelector('select[name="product"]').value);
                const quantity = parseInt(row.querySelector('input[name="quantity"]').value);
                const product = products.find(p => p.id === productId);
                if (!product || isNaN(quantity) || quantity < 1 || quantity > product.stock) {
                    error = true;
                }
            });
            if (error) {
                alert('Verifica que la cantidad no supere el stock disponible y que todos los campos estén completos.');
                return;
            }
            rows.forEach(row => {
                const productId = parseInt(row.querySelector('select[name="product"]').value);
                const quantity = parseInt(row.querySelector('input[name="quantity"]').value);
                const product = products.find(p => p.id === productId);
                if (product) {
                    product.stock -= quantity;
                    movements.push({
                        id: Date.now() + Math.random(),
                        productId: product.id,
                        productName: product.name,
                        type: 'salida',
                        quantity: quantity,
                        reason: 'Venta múltiple',
                        date: new Date().toISOString()
                    });
                }
            });
            saveToLocalStorage();
            closeModal('multiSaleModal');
            updateDisplay();
            renderRecentMovements(); // <-- Asegura actualización inmediata
            showNotification('Venta múltiple registrada exitosamente', 'success');
        });
        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
